# AI-CONTEXT FIRST

## AI-RULES (ЗАПРЕЩЕНО РЕДАКТИРОВАТЬ БЕЗ ПРЯМОГО СОГЛАСИЯ ПОЛЬЗОВАТЕЛЯ)
- Агент обязан поддерживать этот README.md в актуальном состоянии (цель проекта, структура, зависимости, решения).
- Секция ## AI-RULES не изменяется и не удаляется без моего явного подтверждения.
- Все изменения кода — только через git-ветки, миграции с down-скриптами, конфиги вне кода.
- Агент обязан помогать с нуля создавать структуру, шаблоны, CI/CD, тесты, окружения.
- Мягкий dry: считаем risk = high при изменениях infra/migrations или схемы БД, при добавлении зависимостей, при изменении >100 строк данных/массовой обработке или при правке AI-RULES; если risk=low → apply, если risk=medium → short preview (unified diff + 1-line) + snapshot (обязательно включить git-контекст: HEAD, ветка, статус/diff), если risk=high → pause и ждать подтверждения владельца.
- Агент может предлагать дополнительные правила dry как `deviation` (причина, влияние, rollback) — они действуют только после явного подтверждения владельца или после merge PR с успешным CI.
- Формат логов: `{LEVEL} | {component} | {message}` (одна строка, русский язык)
- Docstrings и комментарии к функциям/классам — только русский, максимум 1 строка.
- Язык реализации: Python 3.11+, async где уместно.
- Перед любым крупным изменением (рефакторинг, миграции, новые зависимости) — обязательный план + ожидание подтверждения.
- Всё, что ниже линии `---`, агент может свободно редактировать без подтверждения.

- **Минимальная и обязательная структура README.md (агент обязан создавать и поддерживать именно в таком порядке):**
  1. `# AI-CONTEXT FIRST` (первая строка файла)
  2. `## AI-RULES (...)` (эта секция, фиксированная)
  3. `---` (разделитель, после него агент редактирует свободно)
  4. `## Цель проекта` (1–3 предложения, всегда актуально)
  5. `## Текущие задачи` (чек-лист с [ ] / [x])
  6. `## Стек` (список ключевых библиотек и версий)
  7. `## Структура проекта` (код-блок с tree-структурой корня проекта)
  8. `## Human-only (...)` (всё, что ниже — только для человека, агент НЕ читает и НЕ использует для задач)

- **Дополнения, которые агент обязан добавлять при необходимости (критично для контекста):**
  - `## Важные решения` — архитектурные выборы, причины отказа от альтернатив, известные ограничения.
  - `## Ключевые зависимости` — если в ## Стек стало слишком много, выносить критичные с версиями и причинами выбора.
  - `## Известные проблемы` — баги, TODO, технический долг.
  - `## Секреты и доступы` — список требуемых env-переменных с описанием (без значений).
  - Любые новые секции только после ## Структура проекта и строго с заголовком уровня ##.

---
## Цель проекта
Автоматизированный ETL пайплайн для экстракции данных из Google Sheets, их нормализации и загрузки в базу данных Supabase (PostgreSQL). Проект обеспечивает инкрементальные обновления и построение аналитических витрин данных.

## Текущие задачи
- [x] Отказ от Poetry и переход на pip / requirements.txt
- [x] Исправление и настройка GitHub Actions (CI & ETL workflows)
- [ ] Оптимизация инкрементальной загрузки данных
- [ ] Расширение покрытия тестами (особенно для модуля auth и db)

## Стек
- **Language**: Python 3.11+
- **Data Processing**: Pandas, PyArrow
- **Database**: AsyncPG, Supabase (PostgreSQL), Alembic (migrations)
- **Google Integrations**: Google-Auth, Google-API-Python-Client, GSpread
- **Configuration**: Pydantic, Pydantic-Settings, Python-Dotenv
- **Utilities**: Tenacity (retries), Aiohttp (async requests), Aiofiles
- **Testing**: Pytest, Pytest-Asyncio

## Структура проекта
```text
chilekids-etl-pipeline/
├── src/                # Основной исходный код
│   ├── config.py       # Управление конфигурацией и env-переменными
│   ├── db.py           # Асинхронное взаимодействие с базой данных
│   ├── sheets.py       # Логика работы с Google Sheets API
│   ├── transform.py    # Очистка, нормализация и подготовка данных
│   ├── marts.py        # SQL-логика для построения витрин (Data Marts)
│   └── utils.py        # Вспомогательные утилиты
├── tests/              # Модульные и интеграционные тесты
├── configs/            # Дополнительные конфигурационные файлы
├── .github/workflows/  # CI/CD пайплайны (etl.yml, ci.yml)
├── main.py             # Единая точка входа (CLI) приложения
├── run.sh              # Скрипт быстрого запуска
├── fast_push.sh        # Скрипт для быстрого коммита и пуша
├── Dockerfile          # Описание Docker-образа
└── requirements.txt    # Список зависимостей (pip)
```

# Human-only (АГЕНТУ НЕ ОБЯЗАТЕЛЬНО ЧИТАТЬ ЭТУ СЕКЦИЮ)
```bash
# Как запустить локально
1. **Подготовка окружения:**
   ```bash
   # Создать и активировать виртуальное окружение
   python3 -m venv .venv
   source .venv/bin/activate
   
   # Установить зависимости
   pip install -r requirements.txt
   ```

2. **Настройка переменных (.env):**
   Скопируйте пример или создайте `.env`:
   ```ini
   POSTGRES_URI=postgresql://user:pass@host:port/dbname
   SUPABASE_URL=...
   SUPABASE_SERVICE_KEY=...
   SHEETS_SA_JSON=secrets/service_account.json
   ```

3. **Запуск:**
   ```bash
   # Быстрый запуск обертки (активирует venv, ставит зависимости, запускает)
   ./run.sh run --test
   
   # Или вручную
   python main.py run
   ```

# Разработка
- **Нормализация:** Логика парсинга полей находится в `src/transform.py`.
- **Витрины:** SQL запросы для витрин находятся в `src/marts.py`.
- **Конфиг:** Все настройки в `src/config.py`.
- **Зависимости:** Управляются через `requirements.txt`.
- **Docker**: `docker-compose up --build app` для локального запуска в контейнере.
- **Linting**: Проверка стиля и типов не настроена жестко, но рекомендуется следовать PEP8.
