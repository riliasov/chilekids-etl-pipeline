# –ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–∞–Ω–Ω—ã—Ö (Data Contracts)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î (ELT Layers)
–ë–∞–∑–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É **ELT (Extract, Load, Transform)** –≤ —Ç—Ä–∏ —Å–ª–æ—è:
1.  **RAW**: "–°—ã—Ä–æ–π" JSON. –ú—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—é–¥–∞. –≠—Ç–æ –Ω–∞—à –∞—É–¥–∏—Ç.
2.  **STAGING**: "–ß–∏—Å—Ç—ã–µ" –¥–∞–Ω–Ω—ã–µ. –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è (–¥–∞—Ç—ã, —á–∏—Å–ª–∞), –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–µ –∫ –µ–¥–∏–Ω–æ–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É.
3.  **MARTS**: "–í–∏—Ç—Ä–∏–Ω—ã". –ì–æ—Ç–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Web App –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤.

---

## 1. –°—Ö–µ–º–∞ RAW
–¢–∞–±–ª–∏—Ü–∞ `raw.data` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
*   `id`: –°—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∏–∑ Google Sheets –∏–ª–∏ –∞–≤—Ç–æ-—Ö–µ—à.
*   `payload`: –í–µ—Å—å —Ä—è–¥ —Ç–∞–±–ª–∏—Ü—ã –∫–∞–∫ –µ—Å—Ç—å.
*   `payload_hash`: –°–ª–µ–ø–æ–∫ –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ï—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî —Å–∫—Ä–∏–ø—Ç –∑–Ω–∞–µ—Ç, —á—Ç–æ —Å—Ç—Ä–æ–∫—É –Ω–∞–¥–æ –æ–±–Ω–æ–≤–∏—Ç—å.

---

## 2. –°—Ö–µ–º–∞ STAGING
–¢–∞–±–ª–∏—Ü–∞ `staging.records` ‚Äî —Å–µ—Ä–¥—Ü–µ —Å–∏—Å—Ç–µ–º—ã. –ó–¥–µ—Å—å –¥–∞–Ω–Ω—ã–µ "—Å–ø–ª–∞–≤–ª—è—é—Ç—Å—è" (Fusion) –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª–µ–π:

#### üü¢ Core (–ö—Ç–æ, —á—Ç–æ, –∫–æ–≥–¥–∞)
- `raw_id`: –°–≤—è–∑—å —Å —Å—ã—Ä—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.
- `date` / `payment_date`: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è —É—á–µ—Ç–∞.
- `client` / `vendor`: –°—É–±—ä–µ–∫—Ç—ã —Å–¥–µ–ª–∫–∏.
- `type`: –¢–∏–ø (–î–æ—Ö–æ–¥/–†–∞—Å—Ö–æ–¥/–ü—Ä–æ—á–µ–µ).
- `category` / `subcategory`: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞.

#### üí∞ Finance (–î–µ–Ω—å–≥–∏)
- `total_rub` / `total_usd`: –û—Å–Ω–æ–≤–Ω—ã–µ —Å—É–º–º—ã (–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫ RUB/USD).
- `currency`: –ò—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞.
- `fx_rub` / `fx_usd`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç.
- `rub_summa` / `usd_summa`: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤.

#### üõ† Metadata & Legacy (–°–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è)
- `source_type`: –ú–µ—Ç–∫–∞ (`live`, `static`, `ref`) ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –¥–µ—Ä–∂–∞—Ç—å –∏ —Ç–µ–∫—É—â–∏–π Excel, –∏ –∞—Ä—Ö–∏–≤ –∑–∞ 2010 –≥–æ–¥.
- `cat_new` / `cat_final`: –í–∞—Ä–∏–∞–Ω—Ç—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –º—ç–ø–ø–∏–Ω–≥–∞.
- `paket` / `service`: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ª—É–≥.
- `approver` / `cashier`: –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞ –ø—Ä–æ–≤–æ–¥–∫—É.

#### üîç Analysis (–î–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤)
- `year`, `month`, `quarter`: –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è GROUP BY.
- `hours`: –£—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ).

---

## 3. –°—Ö–µ–º–∞ MARTS
views –≤ —Å—Ö–µ–º–µ `marts` –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.
- **`marts.web_transactions_v`**: –ò—Å–∫–ª—é—á–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (—Ö–µ—à–∏, —Å—ã—Ä–æ–π JSON), –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞ UI.
- **`marts.financials_v`**: –°—á–∏—Ç–∞–µ—Ç P&L (–ø—Ä–∏–±—ã–ª–∏ –∏ —É–±—ã—Ç–∫–∏) –Ω–∞ –ª–µ—Ç—É.

---

## 4. –°—Ö–µ–º–∞ AUDIT (–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π)
–°–ª–æ–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –≤—Å–µ—Ö –ø—Ä–∞–≤–æ–∫. –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è Python-–ø–∞–π–ø–ª–∞–π–Ω–æ–º –ø—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `payload_hash`.

### –¢–∞–±–ª–∏—Ü–∞ `audit.logs`
| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `id` | `SERIAL` | PK –ª–æ–≥–∞. |
| `record_id` | `TEXT` | UUID –∑–∞–ø–∏—Å–∏ –∏–∑ Sheets. |
| `field_name` | `TEXT` | –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–∏–≤—à–µ–π—Å—è –∫–æ–ª–æ–Ω–∫–∏ (–∏–ª–∏ 'payload' –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏). |
| `old_value` | `JSONB` | –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. |
| `new_value` | `JSONB` | –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. |
| `changed_at` | `TIMESTAMPTZ` | –í—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è. |
| `changed_by` | `TEXT` | Email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Sheets (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ). |

---

## 5. Metadata Policy (UUID + Hash)
- **Primary Key (PK)**: –í—Å–µ–≥–¥–∞ **UUID**. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
- **Content Hash**: MD5/SHA —Ö–µ—à –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –ú–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–π –ø—Ä–∞–≤–∫–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ ELT.
- **–°–≤—è–∑–∫–∞**: UUID –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–º "–ö–¢–û" —ç—Ç–æ (–æ–±—ä–µ–∫—Ç), Hash –≥–æ–≤–æ—Ä–∏—Ç –Ω–∞–º "–ß–¢–û" –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (—Å–æ—Å—Ç–æ—è–Ω–∏–µ). –≠—Ç–æ ‚Äî **–∑–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç** –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.
